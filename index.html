<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Palermo incidenti stradali dal 2015 al 2023 - Dashboard by @opendatasicilia</title>
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <META HTTP-EQUIV="refresh" CONTENT="3600">  
    <meta name="description" content="Dashboard interattiva degli incidenti stradali a Palermo">
    <meta name="keywords" content="Open Data, Sicilia, Palermo, Incidenti Stradali">
    <meta name="author" content="Giovan Battista Vitrano per OpenDataSicilia.it">
    
    <link rel="shortcut icon" href="favicon.ico"/> 
    <link rel="icon" href="favicon.png" type="image/png"/> 
    
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
       <link rel="stylesheet" href="css/incidenti.css">
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body>
    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="header">
            <div class="header-content">
                <h1>üöó Incidenti Stradali</h1>
                <p>Palermo 2015-2023 ‚Ä¢ Dashboard Interattiva</p>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-label-main">Statistiche Filtrate</div>
            <div class="stat-grid">
                <div class="stat-item mortale">
                    <div class="stat-label">Mortali</div>
                    <div class="stat-value" id="stat-mortale">0</div>
                </div>
                <div class="stat-item riserva">
                    <div class="stat-label">Riserva</div>
                    <div class="stat-value" id="stat-riserva">0</div>
                </div>
                <div class="stat-item feriti">
                    <div class="stat-label">Feriti</div>
                    <div class="stat-value" id="stat-feriti">0</div>
                </div>
                <div class="stat-item cose">
                    <div class="stat-label">Cose</div>
                    <div class="stat-value" id="stat-cose">0</div>
                </div>
            </div>
            <div class="stat-total">
                <div class="stat-label">Totale Incidenti</div>
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-info" id="total-info">
                    <span>‚úì Dati caricati</span>
                    <span class="info-icon" id="info-icon-btn" title="Informazioni sui dati">i</span>
                </div>
            </div>
            
            <div class="year-stats">
                <div class="year-stats-title">üìä Distribuzione per Anno (clicca per filtrare)</div>
                <div class="year-stats-grid" id="year-stats-grid"></div>
            </div>
        </div>

        <div class="filters">
            <button class="btn-heatmap" id="btn-toggle-heatmap">
                üî• Mappa di Calore
            </button>
            <br>
            <div class="filter-group hidden">
                <label class="filter-label">Tipologia Incidente</label>
                <select id="filter-tipologia">
                    <option value="">Tutte le tipologie</option>
                    <option value="M">M - Mortale</option>
                    <option value="R">R - Riserva</option>
                    <option value="F">F - Feriti</option>
                    <option value="C">C - Cose</option>
                </select>
            </div>
            <br>
            <div class="filter-section">
                <div class="filter-section-header" data-section="localizzazione">
                    <span>üìç Localizzazione</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-localizzazione">
                    <div class="filter-group">
                        <label class="filter-label">Circoscrizioni</label>
                        <select id="filter-circoscrizione"></select>
                        <div class="filter-cascade-info">Filtra Quartiere e UPL ‚Üì</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Quartieri</label>
                        <select id="filter-quartiere"></select>
                        <div class="filter-cascade-info">Filtra UPL ‚Üì</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Unit√† di primo livello</label>
                        <select id="filter-upl"></select>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-section-header" data-section="temporale">
                    <span>üìÖ Analisi Temporale</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-temporale">
                    <div class="filter-group hidden">
                        <label class="filter-label">Anno</label>
                        <select id="filter-anno"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Stagione</label>
                        <select id="filter-stagione"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Mese</label>
                        <select id="filter-mese"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Giorno Settimana</label>
                        <select id="filter-giorno-settimana"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Feriale/Weekend</label>
                        <select id="filter-feriale-weekend"></select>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-section-header" data-section="condizioni">
                    <span>üå§Ô∏è Condizioni e Orari</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-condizioni">
                    <div class="filter-group">
                        <label class="filter-label">Giorno/Notte</label>
                        <select id="filter-giorno-notte"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Condizioni Luce</label>
                        <select id="filter-condizioni-luce"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Fascia Oraria (4 fasce)</label>
                        <select id="filter-fascia-4"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Fascia Oraria (6 fasce)</label>
                        <select id="filter-fascia-6"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ora di Punta</label>
                        <select id="filter-ora-punta"></select>
                    </div>
                </div>
            </div>

            <button class="btn-reset" id="btn-reset" title="Reset Filtri">üîÑ Reset Filtri</button>
            <button class="btn-data-table" id="btn-data-table" title="Visualizza e scarica i dati selezionati">üìä Tabella Dati</button>
            <a href="https://www.dati.gov.it/view-dataset?Cerca=incidenti+palermo" title="Agenzia per l'Italia Digitale" target="_blank" rel="noopener noreferrer" class="btn-fonte">
                üìÑ Fonte Dati: dati.gov.it
            </a>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>
    
    <!-- Map Controls Container -->
    <div class="map-controls-container">
        <div class="map-control-panel">
            <select id="basemap-select" title="Seleziona Mappa di Base">
                <option value="carto-dark" selected>Carto Dark</option>
                <option value="osm">OpenStreetMap</option>
                <option value="satellite">Satellite</option>
                <option value="carto-light">Carto Light</option>
            </select>
            <button class="btn-map-control btn-heatmap-map" id="btn-heatmap-map" title="Attiva/Disattiva Mappa di Calore">
                üî• Calore
            </button>
            <button class="btn-map-control btn-data-table-map" id="btn-data-table-map" title="Visualizza Tabella Dati">
                üìä Tabella
            </button>
            <button class="btn-map-control btn-analytics-map" id="btn-analytics-map" title="Analisi Avanzata">
                üìà Analisi
            </button>
            <button class="btn-map-control btn-reset-map" id="btn-reset-map" title="Reset Filtri">
                üîÑ Reset
            </button>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend" id="points-legend">
        <h3>Legenda (clicca per filtrare)</h3>
        <div class="legend-item" data-tipo="">
            <div style="display: flex; align-items: center;">
                <div style="width: 24px; height: 24px; margin-right: 12px; border-radius: 50%; background: linear-gradient(135deg, #ef4444, #f97316, #f59e0b, #10b981); border: 2px solid rgba(241, 245, 249, 0.3);"></div>
                <span><strong>Tutte</strong> - Tutte le tipologie</span>
            </div>
        </div>
        <div class="legend-item" data-tipo="M">
            <div style="display: flex; align-items: center;">
                <div class="legend-color" style="background-color: #ef4444;"></div>
                <span><strong>M</strong> - Mortale</span>
            </div>
        </div>
        <div class="legend-item" data-tipo="R">
            <div style="display: flex; align-items: center;">
                <div class="legend-color" style="background-color: #a855f7;"></div>
                <span><strong>R</strong> - Riserva</span>
            </div>
        </div>
        <div class="legend-item" data-tipo="F">
            <div style="display: flex; align-items: center;">
                <div class="legend-color" style="background-color: #f59e0b;"></div>
                <span><strong>F</strong> - Feriti</span>
            </div>
        </div>
        <div class="legend-item" data-tipo="C">
            <div style="display: flex; align-items: center;">
                <div class="legend-color" style="background-color: #10b981;"></div>
                <span><strong>C</strong> - Cose</span>
            </div>
        </div>
    </div>

    <!-- Heatmap Legend -->
    <div class="heatmap-legend hidden" id="heatmap-legend">
        <h3>Densit√† Incidenti</h3>
        <div class="heatmap-gradient"></div>
        <div class="heatmap-labels">
            <span>Bassa</span>
            <span>Alta</span>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div>Caricamento dati CSV...</div>
        <small>Attendere prego</small>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detail-panel">
        <div class="detail-header">
            <button class="detail-close" id="detail-close">√ó</button>
            <h2 id="detail-tipo-header">
                <span id="detail-tipo-icon">üöó</span>
                Dettagli Incidente
            </h2>
            <p id="detail-subtitle">Informazioni complete</p>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>

    <!-- Info Modal -->
    <div class="modal" id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ÑπÔ∏è Informazioni sui Dati</h3>
                <button class="modal-close" id="info-modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <p><strong>Dataset completo:</strong> 28.239 incidenti registrati a Palermo dal 2015 al 2023.</p>
                <p><strong>Incidenti mappati:</strong> 23.487 incidenti (83,2% del totale) con coordinate geografiche valide.</p>
                <p><strong>Esclusioni:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 16px;">
                    <li style="margin-bottom: 8px;"><strong>1.560 incidenti (5,5%)</strong> - Coordinate esterne ai confini comunali</li>
                    <li><strong>3.192 incidenti del 2019 (11,3%)</strong> - Privi di coordinate geografiche</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Data Table Modal -->
    <div class="modal" id="data-table-modal">
        <div class="modal-content" style="max-width: 90vw;">
            <div class="modal-header">
                <h3>üìä Tabella Dati Incidenti Filtrati</h3>
                <button class="modal-close" id="data-table-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="table-actions">
                    <button class="btn-download" id="btn-download-csv">‚¨áÔ∏è Scarica CSV</button>
                    <button class="btn-download" id="btn-download-json">‚¨áÔ∏è Scarica JSON</button>
                </div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">
                    <strong id="table-count">0</strong> incidenti visualizzati
                </div>
                <div class="table-container">
                    <table class="data-table" id="data-table">
                        <thead id="table-header"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div class="analytics-panel" id="analytics-panel">
        <div class="analytics-header">
            <div class="analytics-header-top">
                <h2>üìà Analisi Avanzata Incidenti</h2>
                <button class="analytics-close" id="analytics-close">√ó</button>
            </div>
            <div class="analytics-filters-info" id="analytics-filters-info">
                <strong>Dati Visualizzati:</strong>
                <span id="active-filters-text">Tutti gli incidenti (2015-2023)</span>
            </div>
        </div>
        
        <div class="analytics-tabs">
            <button class="analytics-tab active" data-tab="panoramica">üìä Panoramica</button>
            <button class="analytics-tab" data-tab="temporale">üìÖ Temporale</button>
            <button class="analytics-tab" data-tab="oraria">‚è∞ Oraria</button>
            <button class="analytics-tab" data-tab="condizioni">üå§Ô∏è Condizioni</button>
            <button class="analytics-tab" data-tab="insights">üí° Insights</button>
        </div>

        <div class="analytics-content">
            <!-- Panoramica Tab -->
            <div class="analytics-tab-content active" id="tab-panoramica">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Trend Annuale Incidenti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-trend-annuale"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Distribuzione per Tipologia</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-tipologia"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Analisi Stagionale</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-stagionale"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Feriale vs Weekend</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-feriale-weekend"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temporale Tab -->
            <div class="analytics-tab-content" id="tab-temporale">
                <div class="charts-grid">
                    <div class="chart-container chart-full">
                        <h3>Distribuzione per Giorno della Settimana</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-giorno-settimana"></canvas>
                        </div>
                    </div>
                    <div class="chart-container chart-full">
                        <h3>Evoluzione Annuale (Feriti vs Non Feriti)</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-evoluzione-anni"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Oraria Tab -->
            <div class="analytics-tab-content" id="tab-oraria">
                <div class="charts-grid">
                    <div class="chart-container chart-full">
                        <h3>Distribuzione per Fascia Oraria</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-fascia-oraria"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Top 3 Fasce per Incidenti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-top-incidenti"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Top 3 Fasce per Feriti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-top-feriti"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Condizioni Tab -->
            <div class="analytics-tab-content" id="tab-condizioni">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Luce vs Buio</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-luce-buio"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Dettaglio Condizioni Luce</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-condizioni-dettaglio"></canvas>
                        </div>
                    </div>
                    <div class="chart-container chart-full">
                        <h3>Confronto Stagionale delle Condizioni</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-stagioni-condizioni"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="analytics-tab-content" id="tab-insights">
                <div class="insights-container">
                    <div class="stats-realtime">
                        <h3>üìä Statistiche in Tempo Reale</h3>
                        <div class="stats-realtime-grid">
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Totale Incidenti</div>
                                <div class="stat-realtime-value" id="realtime-total">0</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Totale Feriti</div>
                                <div class="stat-realtime-value" id="realtime-feriti">0</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">% con Feriti</div>
                                <div class="stat-realtime-value" id="realtime-percentuale">0%</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Media Feriti</div>
                                <div class="stat-realtime-value" id="realtime-media">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="insights-auto">
                        <h3>üí° Insights Automatici</h3>
                        <div class="insight-item">
                            <div class="insight-icon">üìÖ</div>
                            <div class="insight-content">
                                <div class="insight-label">Giorno pi√π pericoloso</div>
                                <div class="insight-value" id="insight-giorno">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">‚è∞</div>
                            <div class="insight-content">
                                <div class="insight-label">Fascia oraria critica</div>
                                <div class="insight-value" id="insight-fascia">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">üçÇ</div>
                            <div class="insight-content">
                                <div class="insight-label">Stagione pi√π rischiosa</div>
                                <div class="insight-value" id="insight-stagione">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">üåô</div>
                            <div class="insight-content">
                                <div class="insight-label">Condizione pi√π pericolosa</div>
                                <div class="insight-value" id="insight-condizione">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="js/incidenti.js"></script>
</body>
</html>