<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Palermo incidenti stradali dal 2015 al 2023 - Dashboard by @opendatasicilia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <META HTTP-EQUIV="refresh" CONTENT="3600">  
    <meta name="description" content="Dashboard interattiva degli incidenti stradali a Palermo">
    <meta name="keywords" content="Open Data, Sicilia, Palermo, Incidenti Stradali">
    <meta name="author" content="Giovan Battista Vitrano per OpenDataSicilia.it">
    
    <link rel="shortcut icon" href="favicon.ico"/> 
    <link rel="icon" href="favicon.png" type="image/png"/> 
    <!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
       <link rel="stylesheet" href="css/incidenti.css">
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body>
    <!-- Mobile Toggle -->
    <button class="mobile-toggle" id="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="header">
            <div class="header-content">
                <h1>Incidenti Stradali</h1>
                <p>Palermo 2015-2023 ‚Ä¢ Dashboard Interattiva</p>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-label-main">Statistiche</div>
            <div class="stat-grid">
                <div class="stat-item mortale">
                    <div class="stat-label">Mortali</div>
                    <div class="stat-value" id="stat-mortale">0</div>
                </div>
                <div class="stat-item riserva">
                    <div class="stat-label">Riserva</div>
                    <div class="stat-value" id="stat-riserva">0</div>
                </div>
                <div class="stat-item feriti">
                    <div class="stat-label">Feriti</div>
                    <div class="stat-value" id="stat-feriti">0</div>
                </div>
                <div class="stat-item cose">
                    <div class="stat-label">Cose</div>
                    <div class="stat-value" id="stat-cose">0</div>
                </div>
            </div>
            <div class="stat-total">
                <div class="stat-label">Totale Incidenti</div>
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-info" id="total-info">
                    <span>‚úì Dati caricati</span>
                    <span class="info-icon" id="info-icon-btn" title="Informazioni sui dati">i</span>
                </div>
            </div>
            
            <div class="year-stats">
                <div class="year-stats-title">üìä Distribuzione per Anno (clicca per filtrare)</div>
                <div class="year-stats-grid" id="year-stats-grid"></div>
            </div>
        </div>

        <div class="filters">
            <button class="btn-heatmap" id="btn-toggle-heatmap">
                üî• Mappa di Calore
            </button>
            <br>
            <div class="filter-group hidden">
                <label class="filter-label">Tipologia Incidente</label>
                <select id="filter-tipologia">
                    <option value="">Tutte le tipologie</option>
                    <option value="M">M - Mortale</option>
                    <option value="R">R - Riserva</option>
                    <option value="F">F - Feriti</option>
                    <option value="C">C - Cose</option>
                </select>
            </div>
           <div class="filter-section">
<!-- NUOVO: Sezione Calendario Personalizzato -->
<div class="filter-section" >
    <div class="filter-section-header" data-section="calendario">
        <span>üìÖ Calendario Interattivo</span>
        <span class="toggle-icon collapsed">‚ñº</span>
    </div>
    <div class="filter-section-content collapsed" id="content-calendario">
        <div class="custom-calendar" id="custom-calendar">
            <!-- Controlli Anno -->
            <div class="calendar-year-control">
                <button class="calendar-nav-btn" id="cal-prev-year">¬´</button>
                <div class="calendar-year-display" id="cal-year-display">2023</div>
                <button class="calendar-nav-btn" id="cal-next-year">¬ª</button>
            </div>
            
            <!-- Griglia Mesi -->
            <div class="calendar-months-grid" id="cal-months-grid">
                <!-- Sar√† popolato via JS -->
            </div>
            
            <!-- Griglia Giorni Settimana -->
            <div class="calendar-weekdays-grid" id="cal-weekdays-grid">
                <!-- Sar√† popolato via JS -->
            </div>
            
            <!-- Griglia Giorni del Mese (quando un mese √® selezionato) -->
            <div class="calendar-days-container" id="cal-days-container" style="display: none;">
                <div class="calendar-month-header" id="cal-month-header"></div>
                <div class="calendar-weekday-labels">
                    <div>L</div><div>M</div><div>M</div><div>G</div><div>V</div><div>S</div><div>D</div>
                </div>
                <div class="calendar-days-grid" id="cal-days-grid">
                    <!-- Sar√† popolato via JS -->
                </div>
            </div>
            
            <!-- Riepilogo Selezione -->
            <div class="calendar-selection-summary" id="cal-selection-summary">
                Nessun filtro temporale attivo
            </div>
            
            <!-- Pulsanti Azione -->
            <div class="calendar-actions">
                <button class="btn-calendar-reset" id="btn-calendar-reset">üîÑ Reset</button>
            </div>
        </div>
    </div>
</div>
                <div class="filter-section-header" data-section="localizzazione">
                    <span>üìç Localizzazione</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-localizzazione">
                    <div class="filter-group">
                        <label class="filter-label">Circoscrizioni</label>
                        <select id="filter-circoscrizione"></select>
                        <div class="filter-cascade-info">Filtra Quartiere e UPL ‚Üì</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Quartieri</label>
                        <select id="filter-quartiere"></select>
                        <div class="filter-cascade-info">Filtra UPL ‚Üì</div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Unit√† di primo livello</label>
                        <select id="filter-upl"></select>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-section-header" data-section="temporale">
                    <span>üìÖ Analisi Temporale</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-temporale">
                    <div class="filter-group hidden">
                        <label class="filter-label">Anno</label>
                        <select id="filter-anno"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Stagione</label>
                        <select id="filter-stagione"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Mese</label>
                        <select id="filter-mese"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Giorno Settimana</label>
                        <select id="filter-giorno-settimana"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Feriale/Weekend</label>
                        <select id="filter-feriale-weekend"></select>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-section-header" data-section="condizioni">
                    <span>üå§Ô∏è Condizioni e Orari</span>
                    <span class="toggle-icon collapsed">‚ñº</span>
                </div>
                <div class="filter-section-content collapsed" id="content-condizioni">
                    <div class="filter-group">
                        <label class="filter-label">Giorno/Notte</label>
                        <select id="filter-giorno-notte"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Condizioni Luce</label>
                        <select id="filter-condizioni-luce"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Fascia Oraria (4 fasce)</label>
                        <select id="filter-fascia-4"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Fascia Oraria (6 fasce)</label>
                        <select id="filter-fascia-6"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ora di Punta</label>
                        <select id="filter-ora-punta"></select>
                    </div>
                </div>
            </div>

            <button class="btn-reset" id="btn-reset" title="Reset Filtri">üîÑ Reset Filtri</button>
            <button class="btn-data-table" id="btn-data-table" title="Visualizza e scarica i dati selezionati">üìä Tabella Dati</button>
            <a href="https://www.dati.gov.it/view-dataset?Cerca=incidenti+palermo" title="Agenzia per l'Italia Digitale" target="_blank" rel="noopener noreferrer" class="btn-fonte">
                üìÑ Fonte Dati: dati.gov.it
            </a>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>
    
    <!-- Map Controls Container -->
    <div class="map-controls-container">
   </div>
    
    <!-- Legend -->
<div id="points-legend">
            <select style="margin-bottom: 10px;" id="basemap-select" title="Seleziona Mappa di Base">
                <option value="carto-dark" >Carto Dark</option>
                <option value="osm">OpenStreetMap</option>
                <option value="satellite">Satellite</option>
                <option value="carto-light" selected>Carto Light</option>
            </select>	
			<button class="btn-map-control btn-clustering-map" id="btn-clustering-map" title="Visualizza raggruppamento incidenti per zona"> üîµ Mappa con clustering geografico
</button>
<button class="btn-map-control btn-top-luoghi-map" id="btn-top-luoghi-map" style="display: none;" title="Visualizza/Scarica l'elcono con le 25 vie con pi√π incidenti">
    üèÜ Vie con maggior numero di incidenti
</button>			
			<button class="btn-map-control btn-heatmap-map" id="btn-heatmap-map" title="Attiva/Disattiva Mappa di Calore">
                üî• Heatmap
            </button>

            <button class="btn-map-control btn-data-table-map" id="btn-data-table-map" title="Visualizza/scarica la Tabella dati selezionati">
                üìä Tabella dati
            </button>
            <button class="btn-map-control btn-analytics-map" id="btn-analytics-map" title="Visualizza la Dashboard di Analisi Avanzata">
                üìà Cockpit Analisi
            </button>
   <!--         <button class="btn-map-control btn-reset-map" id="btn-reset-map" title="Reset Filtri">
                üîÑ Reset
            </button>	-->
			<hr>
    <h4>Tipologie Incidenti</h4>
    <div style="height: 170px; top: -10px; position: relative;">
        <canvas id="legend-chart"></canvas>
    </div>
<!-- Switch Giorno/Notte -->
<div style="margin-top: -50px; padding: 5px; /*background: rgba(30, 41, 59, 0.6);*/ border-radius: 8px;">
  <!--   <h4 style="margin: 0 0 12px 0; font-size: 13px; color: #fff; font-weight: 600; text-align: center;">
        üåûüåô Periodo del Giorno
    </h4> -->
    <div style="display: flex; gap: 8px;">
        <button id="switch-giorno" class="period-switch" data-period="Giorno" title="Filtra incidenti diurni">
            <span style="font-size: 10px;">‚òÄÔ∏è</span>
            <span style="font-size: 11px; font-weight: 600;">Giorno</span>
            <span id="count-giorno" style="font-size: 10px; font-weight: 600;">0</span>
        </button>
        <button id="switch-notte" class="period-switch" data-period="Notte" title="Filtra incidenti notturni">
            <span style="font-size: 10px;">üåô</span>
            <span style="font-size: 11px; font-weight: 600;">Notte</span>
            <span id="count-notte" style="font-size: 10px; font-weight: 700;">0</span>
        </button>
    </div>
</div>

<!-- Grafico Area Incidenti e Feriti per Mese -->
<div class="chart-container" style="height: 180px; margin-top: 20px;">
    <h4 style="margin-bottom: 8px; font-size: 13px; color: #fff; font-weight: 600; text-align: left;">
        üìä Incidenti e Feriti per Mese
    </h4>
    <canvas id="monthly-area-chart"></canvas>
</div>

<!-- Grafico Radar Feriti/Morti per Mese -->
<div class="chart-container" style="height: 220px; margin-top: 20px; bottom: 20px;">
    <h4 style="margin-bottom: 8px; font-size: 13px; color: #fff; font-weight: 600; text-align: left;">
     üöë Feriti/Morti per Mese
    </h4>
    <canvas id="monthly-injuries-chart"></canvas>
</div> <br>	
<button class="btn-map-control btn-reset-map" id="btn-reset-map" title="Reset Filtri">
 üîÑ Reset
 </button>	
<button id="btn-reset-charts" class="btn-reset-charts" title="Resetta tutti i filtri grafici">
    <span style="font-size: 12px;">‚Üª</span> Reset Filtri Grafici
</button>
</div>

   <!-- Heatmap Legend -->
    <div class="heatmap-legend hidden" id="heatmap-legend">
        <h3>Densit√† Incidenti</h3>
        <div class="heatmap-gradient"></div>
        <div class="heatmap-labels">
            <span>Bassa</span>
            <span>Alta</span>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div>Caricamento dati CSV...</div>
        <small>Attendere prego</small>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detail-panel">
        <div class="detail-header">
            <button class="detail-close" id="detail-close">√ó</button>
            <h2 id="detail-tipo-header">
                <span id="detail-tipo-icon">üöó</span>
                Dettagli Incidente
            </h2>
            <p id="detail-subtitle">Informazioni complete</p>
        </div>
        <div class="detail-content" id="detail-content"></div>
    </div>

    <!-- Info Modal -->
    <div class="modal" id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ÑπÔ∏è Informazioni sui Dati</h3>
                <button class="modal-close" id="info-modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <p><strong>Dataset completo:</strong> 28.239 incidenti registrati a Palermo dal 2015 al 2023.</p>
                <p><strong>Incidenti mappati:</strong> 23.487 incidenti (83,2% del totale) con coordinate geografiche valide.</p>
                <p><strong>Esclusioni:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 16px;">
                    <li style="margin-bottom: 8px;"><strong>1.560 incidenti (5,5%)</strong> - Coordinate esterne ai confini comunali</li>
                    <li><strong>3.192 incidenti del 2019 (11,3%)</strong> - Privi di coordinate geografiche</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Data Table Modal -->
    <div class="modal" id="data-table-modal">
        <div class="modal-content" style="max-width: 90vw;">
            <div class="modal-header">
                <h3>üìä Tabella Dati Incidenti Filtrati</h3>
                <button class="modal-close" id="data-table-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="table-actions">
                    <button class="btn-download" id="btn-download-csv">‚¨áÔ∏è Scarica CSV</button>
                    <button class="btn-download" id="btn-download-json">‚¨áÔ∏è Scarica JSON</button>
                </div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">
                    <strong id="table-count">0</strong> incidenti visualizzati
                </div>
                <div class="table-container">
                    <table class="data-table" id="data-table">
                        <thead id="table-header"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div class="analytics-panel" id="analytics-panel">
        <div class="analytics-header">
            <div class="analytics-header-top">
                <h2>üìà Analisi Avanzata Incidenti</h2>
                <button class="analytics-close" id="analytics-close">√ó</button>
            </div>
            <div class="analytics-filters-info" id="analytics-filters-info">
                <strong>Dati Visualizzati:</strong>
                <span id="active-filters-text">Tutti gli incidenti (2015-2023)</span>
            </div>
        </div>
        
        <div class="analytics-tabs">
            <button class="analytics-tab active" data-tab="panoramica">üìä Panoramica</button>
            <button class="analytics-tab" data-tab="temporale">üìÖ Temporale</button>
            <button class="analytics-tab" data-tab="oraria">‚è∞ Oraria</button>
            <button class="analytics-tab" data-tab="condizioni">üå§Ô∏è Condizioni</button>
            <button class="analytics-tab" data-tab="insights">üí° Insights</button>
        </div>

        <div class="analytics-content">
            <!-- Panoramica Tab -->
            <div class="analytics-tab-content active" id="tab-panoramica">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Trend Annuale Incidenti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-trend-annuale"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Distribuzione per Tipologia</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-tipologia"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Analisi Stagionale</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-stagionale"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Feriale vs Weekend</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-feriale-weekend"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temporale Tab -->
            <div class="analytics-tab-content" id="tab-temporale">
                <div class="charts-grid">
                    <div class="chart-container chart-full">
                        <h3>Distribuzione per Giorno della Settimana</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-giorno-settimana"></canvas>
                        </div>
                    </div>
                    <div class="chart-container chart-full">
                        <h3>Evoluzione Annuale (Feriti vs Non Feriti)</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-evoluzione-anni"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Oraria Tab -->
            <div class="analytics-tab-content" id="tab-oraria">
                <div class="charts-grid">
                    <div class="chart-container chart-full">
                        <h3>Distribuzione per Fascia Oraria</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-fascia-oraria"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Top 3 Fasce per Incidenti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-top-incidenti"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Top 3 Fasce per Feriti</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-top-feriti"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Condizioni Tab -->
            <div class="analytics-tab-content" id="tab-condizioni">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Luce vs Buio</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-luce-buio"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Dettaglio Condizioni Luce</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-condizioni-dettaglio"></canvas>
                        </div>
                    </div>
                    <div class="chart-container chart-full">
                        <h3>Confronto Stagionale delle Condizioni</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-stagioni-condizioni"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="analytics-tab-content" id="tab-insights">
                <div class="insights-container">
                    <div class="stats-realtime">
                        <h3>üìä Statistiche in Tempo Reale</h3>
                        <div class="stats-realtime-grid">
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Totale Incidenti</div>
                                <div class="stat-realtime-value" id="realtime-total">0</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Totale Feriti</div>
                                <div class="stat-realtime-value" id="realtime-feriti">0</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">% con Feriti</div>
                                <div class="stat-realtime-value" id="realtime-percentuale">0%</div>
                            </div>
                            <div class="stat-realtime-item">
                                <div class="stat-realtime-label">Media Feriti</div>
                                <div class="stat-realtime-value" id="realtime-media">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="insights-auto">
                        <h3>üí° Insights Automatici</h3>
                        <div class="insight-item">
                            <div class="insight-icon">üìÖ</div>
                            <div class="insight-content">
                                <div class="insight-label">Giorno pi√π pericoloso</div>
                                <div class="insight-value" id="insight-giorno">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">‚è∞</div>
                            <div class="insight-content">
                                <div class="insight-label">Fascia oraria critica</div>
                                <div class="insight-value" id="insight-fascia">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">üçÇ</div>
                            <div class="insight-content">
                                <div class="insight-label">Stagione pi√π rischiosa</div>
                                <div class="insight-value" id="insight-stagione">-</div>
                            </div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">üåô</div>
                            <div class="insight-content">
                                <div class="insight-label">Condizione pi√π pericolosa</div>
                                <div class="insight-value" id="insight-condizione">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Top Luoghi Modal -->
<div class="modal" id="top-luoghi-modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3>üèÜ Top 25 vie con pi√π incidenti</h3>
            <button class="modal-close" id="top-luoghi-close">√ó</button>
        </div>
        <div class="modal-body">
            <div class="table-actions">
                <button class="btn-download" id="btn-download-luoghi-csv">Scarica CSV</button>
                <div style="color: #94a3b8; font-size: 12px;">
                    <strong id="top-luoghi-count">0</strong> luoghi analizzati
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="top-luoghi-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>Indirizzo</th>
                            <th style="width: 100px;">Totale</th>
                            <th style="width: 80px;">Mortali</th>
                            <th style="width: 80px;">Riserva</th>
                            <th style="width: 80px;">Feriti</th>
                            <th style="width: 80px;">Cose</th>
                            <th style="width: 120px;">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="top-luoghi-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="js/incidenti_smart.js"></script>
</body>
</html>